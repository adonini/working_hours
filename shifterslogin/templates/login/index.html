{% extends 'login/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
</style>
<div class="container mt-1">
    <div class="row">
		{% if user.is_authenticated %}
			<!-- Main Content -->
			<div class="col-md-9 mb-3 mb-md-0 text-center">
				{% if active_shift %}
					<h1 class="fw-light">Welcome back, {{ user.username }}!</h1>
					<div class="alert alert-warning border-2 font-weight-bold w-auto d-inline-block">You have an active shift!</div>
					<p class="fw-light">You started your shift at: {{ active_shift.shift_start }}</p>
					<a class="mt-4 btn btn-outline-info btn-font border-4 p-4 text-dark font-weight-bold d-inline-flex justify-content-center align-items-center rounded shadow continue-shift-btn" 
					href="{% url 'shift_details' %}">
						<i class="fa-solid fa-arrow-right-to-bracket me-3"></i> Go to Active Shift
					</a>
				{% else %}
					<div>
						<h1 class="fw-light">Welcome back, {{ user.username }}!</h1>
						<p class="fw-light">If you are having a night off, press the "Night off" button.</p>
						<p class="fw-light">To start counting working time press "Start shift".</p>
						<div class="d-flex justify-content-center">
							<a class="btn btn-outline-success btn-font mx-2 border-4 p-4 text-dark font-weight-bold d-flex justify-content-center align-items-center rounded shadow start-shift-btn"
								href="javascript:void(0);" id="start-shift-btn">
								<i class="fa-regular fa-circle-play me-2"></i> Start shift
							</a>
							<a class="btn btn-outline-warning btn-font mx-2 border-4 text-dark p-4 font-weight-bold d-flex justify-content-center align-items-center rounded shadow off-night-btn"
								href="javascript:void(0);" id="night-off-btn">
								<img src="{% static 'svg/moon-sleep.svg' %}" alt="Night off icon" class="me-2" width="50" height="50"> Night Off
							</a>
						</div>
					</div>
				{% endif %}
			</div>
			<!-- Sidebar -->
			<div class="col-md-3 mt-2">
				<div class="sidebar custom-sidebar">
					<p class="d-flex fs-4 justify-content-center align-items-center text-center" id="current-date-time"></p>

					<p class="text-center fs-4 mt-4 d-flex justify-content-center align-items-center font-weight-bold"> Day Total</p>
					<p class="text-center d-flex justify-content-center align-items-center">Work: {{ total_hours_worked_today|floatformat:2 }} hours</p>

					<p class="text-center fs-4 mt-4 d-flex justify-content-center align-items-center font-weight-bold"> Week Total</p>
					<p class="text-center d-flex justify-content-center align-items-center">Work: {{ total_hours_worked_week|floatformat:2 }} hours</p>
				</div>
			</div>

			<!-- History Section -->
			<div class="container mt-5">
				<h2 class="text-center font-weight-bold">Your Shift History</h2>
				<div class="table-responsive">
					<table class="table table-bordered text-center">
						<thead>
							<tr>
								<th>Start Time</th>
								<th>End Time</th>
								<th>Duration</th>
							</tr>
						</thead>
						<tbody>
							{% for shift in shifts_history %}
								<tr>
									<td>{{ shift.shift_start|date:"Y-m-d H:i:s" }}</td>
									<td>
										{% if shift.shift_end %}
											{{ shift.shift_end|date:"Y-m-d H:i:s" }}
										{% else %}
											Ongoing
										{% endif %}
									</td>
									<td>
										{% if shift.duration_hours %}
											{{ shift.duration_hours|floatformat:2 }} hours
										{% else %}
											Ongoing
										{% endif %}
									</td>
								</tr>
							{% empty %}
								<tr>
									<td colspan="3" class="text-center">No history available.</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</div>
		{% else %}
			<div class="text-center">
				<p class="fw-light fs-3">Authenticate yourself to track working hours</p>
				<br/>
				<a href="{% url 'login' %}" class="btn btn-primary p-4 fs-5 font-weight-bold rounded shadow">Log In To Get Started!</a>
			</div>
		{% endif %}
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    $(document).ready(function(){
        $("#start-shift-btn").click(function(event){
            event.preventDefault();
            $.ajax({
                url: "{% url 'start_shift' %}",
                type: "POST",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(data) {
                    window.location.href = "{% url 'shift_details' %}";
                },
                error: function(xhr, status, error) {
                    console.error("AJAX Error:", status, error);
                    alert("An error occurred. Please try again.");
                }
            });
        });
    });

    function updateDateTime() {
        var now = new Date();

        var optionsDay = { weekday: 'long' };
        var formattedDay = now.toLocaleDateString('en-US', optionsDay);

        var optionsDate = { month: 'long', day: 'numeric' };
        var formattedDate = now.toLocaleDateString('en-US', optionsDate);

        var optionsTime = { hour: '2-digit', minute: '2-digit', hour12: false };
        var formattedTime = now.toLocaleTimeString('en-US', optionsTime);

        document.getElementById('current-date-time').innerHTML = `${formattedDay}<br>${formattedDate}<br>${formattedTime}`;
    }

    updateDateTime();
    setInterval(updateDateTime, 60000);
</script>
{% endblock content %}